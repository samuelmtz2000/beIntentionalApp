# Streaks Feature Checkup — 2025-09-19

Summary
- Backend streak endpoints (general, per-habit, history) are live and used by iOS.
- iOS header shows: counts row (Good X/Y in green, Bad total in red) above the progress bar; bar tints green by default and red when any unforgiven bad occurred today; right column shows Heart (life/skull), Coins, then Streak flame.
- Remaining work focuses on store credits UX (forgiveness CTA), milestones/celebration, telemetry, and optional config.

What’s Implemented
- API
  - GET `/streaks/general` → current/longest and today’s breakdown (80% threshold, unforgiven bad breaks; freeze on zero-good + no bad).
  - Includes `unforgivenBadCount` and `totalBadCount` for today.
  - GET `/streaks/habits` → per-habit current/longest for good and bad.
  - GET `/streaks/habits/:id/history?type=good|bad` → 7-day statuses (good: done/miss/inactive; bad: clean/forgiven/occurred).
  - OpenAPI references present; tests exist for general and per-habit.
- iOS
  - Shared model: `app.streaks` is the single header source (no duplicate instances).
  - Header: `PlayerHeader` shows counts row above the bar, color‑coded bar (green→red on unforgiven), and a streak flame; small celebration on daySuccess.
  - List rows: `GoodHabitRow` / `BadHabitRow` show `StreakChip` and 7‑day dots; history sheet available.
  - After actions: handlers refresh header streaks immediately, then refresh list ViewModels.

Gaps / To‑Do
- Header progress meter
  - Add a small progress UI in the header: completedGood / totalActiveGood for today; colorize by at-risk state (unforgiven bad) and success threshold.
  - Status: Implemented with counts row above the bar; bar tints green→red per unforgiven.
- Configuration
  - Expose streak threshold (default 80%) and potentially freeze policy in user config (backend + `UserConfigSheet`).
  - Persist per-user via `/users/:id/config` and apply in streak computations.
- Visual/UX polish
  - Richer celebration (sparkles/confetti) for header on day success; milestone celebrations at 7/30/100.
  - Color semantics for streaks (e.g., flame color scale, at-risk warning state) standardized in Design System.
- Telemetry
  - Track general/per-habit streak metrics; success/failure days; forgiven usage; milestones.
- Docs & OpenAPI
  - Document header progress UI and config fields; ensure OpenAPI mirrors any new config endpoints.

Notes
- Current algorithm: floor(completed/total*100) >= 80 and no unforgiven bad; zero-good days freeze unless an unforgiven bad occurs.
- Per-habit rules: good streak increments on consecutive done; bad “clean” streak increments unless unforgiven occurs (forgiven is neutral).

Next Steps (proposed)
1) Store credits UX: “Forgive Today” CTA after recording bad (consume credit if available); if none, one‑tap “Buy + Forgive” flow.
2) Milestones + celebration: 7/30/100 day streaks; richer animation on daySuccess.
3) Telemetry: define events and wire minimal logging hooks (dailySuccess, unforgiven/forgiven usage, milestones).
4) Optional config: add `streakSuccessThreshold` (default 80%) to `/users/:id/config` and apply in compute.
